/*! Copyright (c) 2016 Mediarithmics; All Rights Reserved */
!function(a,b){"use strict";function c(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function d(a,c){var d=b.createElement("img");d.style.display="none",d.style.width=d.style.height="0px",c&&(d.onload=function(){c(null,a)},d.onerror=function(){var b=new Error("error while loading"+a);b.url=a,c(b,null)}),d.setAttribute("src",a)}function e(a,c){var d=b.createElement("script");d.setAttribute("type","text/javascript"),d.setAttribute("src",a),d.setAttribute("async","true"),c&&(d.onload=function(){c(null,a)},d.onerror=function(){var b=new Error("error while loading"+a);b.url=a,c(b,null)}),b.getElementsByTagName("script")[0].parentNode.appendChild(d)}function f(a){for(var c=b.cookie.split(";"),d=0;d<c.length;d++){var e=c[d].replace(/ /g,"").split("=");if(e[0]===a)return M.debug("found cookie",e[0],e[1]),e[1]}return null}function g(a,b){this.finished=!1,this.ran=!1,this.operators=a,this.retrievedIds=[],this.timeout=b,this.watchDog=null}function h(a){this.properties={$site_token:a},this.ready=!1}function i(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)&&"object"!=typeof a[c]){var d=L[c]||c;b.push(encodeURIComponent(d)+"="+encodeURIComponent(a[c]))}else if("object"==typeof a[c]&&"object"==typeof JSON){var e=L[c]||c;b.push(encodeURIComponent(e)+"=jso-"+encodeURIComponent(JSON.stringify(a[c])))}return b.join("&")}function j(){e(z.config_server_url)}function k(a,b,c){var d=new Date;d.setTime(d.getTime()-24*z.cookie_refresh_in_days*60*60*1e3),a&&c>d.getTime()?setTimeout(function(){N._setUAID(a,A.getVid(),A.getLts())},0):B.gatherOperatorsIds()}function l(a){return a?a-N._startTime:null}function m(){if(M.info("trigger calls if possible: currentPage:",A,"panicMode:",D,", global:",G,"callQueue:",N._callQueue),A&&A.isReady()&&G.$etid||D){var a={};D&&(a.$error=E),o(z.override_transport||d,a)}}function n(a,b){if(a?(I.push(a.url),H--,M.info("error with",a)):(M.info("sucessfully sent",b),H--),C&&0===H){M.info("calling callback function: eventsRunning:",H,"errors:",I);try{C.apply(0===I.lenght)}catch(c){M.error("error has occured while calling callback function",c)}}}function o(a,b){for(var d=N._callQueue,e=b||{};d.length;){var f=l((new Date).getTime());f&&(e.$delay={$push:f,$start:l(J),$gather_id_end:l(K)});var g=d.shift();g=c(g,A.properties),g=c(g,G),g=c(g,e),M.info("pushing",g);var h=z.protocol+z.domain_name+z.events_path+"?"+i(g);H++,a(h,n)}D||(M.info("complete before panicMode, clearing watchDog"),p())}function p(){F&&(M.log("clearing watchdog"),a.clearTimeout(F),F=null)}function q(a){M.info("switching to panic mode ! reason:",a),D=!0,E=a,m()}function r(a){M.info("setup watchdog timer to ",a),p(),F=setTimeout(function(){q("$count_down_1")},a)}function s(a){navigator.sendBeacon(a)}function t(){if(M.log("page is unloading"),navigator.sendBeacon){for(M.log("send call queue with navigator.beacon");I.length;)s(I.shift());H>0&&N.push("$quit_while_running"),o(s,{$error:"page_quit"})}}function u(a,b,c){P[b]?a[b].apply(a,c):M.error("The method '"+b+"' is not supported.")}var v=a.navigator.userAgent;if(!/googlebot|bingbot|yandexbot|baiduspider/i.test(v)){var w="https://cookie-matching.mediarithmics.com",x="1.1.6",y=!1,z={},A=null,B=null,C=null,D=!1,E=null,F=null,G={},H=0,I=[],J=(new Date).getTime(),K=null,L={$user_account_id:"$cuid"},M=function(b){function c(b){return function(){if(z.debug&&a.console&&a.console[b])try{var c=Array.prototype.slice.apply(arguments),d=l((new Date).getTime())/1e3;c.unshift("mics "+d.toFixed(3)+" s"),a.console[b].apply(a.console,c)}catch(e){}}}for(var d={},e=0;e<b.length;e++)d[b[e]]=c(b[e]);return d}("log debug info warn error".split(" ")),N=a.mics;if(!N)throw new Error("mics is not defined. Did you used the provided snippet ?");if(N._tagVersion)return void M.warn("The tag was already loaded, aborting.");N._tagVersion=x;var O={domain_id:1,cookie_matching_url:w+"/v1/getids",gather_operator_id_url:w+"/v1/gather_id",update_cookie_matching_out_url:w+"/v1/update_cm_out",get_id_path:"/v1/get_id",domain_name:"events.mediarithmics.com",protocol:"https://",events_path:"/v1/visits/pixel",config_server_url:"https://events.mediarithmics.com/v1/conf.js",cookie_max_age_in_days:720,cookie_refresh_in_days:10,local_cookie_name:null,gather_id_timeout_ms:2e3,global_timeout_ms:3e3,debug:f("mics_debug_tag"),override_transport:null};g.prototype={gatherOperatorsIds:function(){M.info("CookieMatcher","gatherOperatorsIds",this.operators);for(var b=0;b<this.operators.length;b++)this.gatherId(this.operators[b]);this.ran=!0;var c=this;this.timeout>0&&(this.watchDog=a.setTimeout(function(){c._timeout()},this.timeout))},setEtid:function(a){this.etid=a,this.finishIfPossible()},gatherId:function(a){var b=this;e(z.gather_operator_id_url+"?opid="+a,function(c){c&&(M.info("error while gather_id",a),b.setOperatorId(a,null))})},setOperatorId:function(a,b){M.log("CookieMatcher","setId("+a+", "+b+")"),this.retrievedIds.push(b),this.finished=this.retrievedIds.length===this.operators.length,this.finishIfPossible()},finishIfPossible:function(a){if(M.log("CookieMatcher","try to finish, panicMode:",a,"etid:",this.etid,"finished",this.finished),this.etid&&this.finished||a){K=(new Date).getTime();for(var b=[];this.retrievedIds.length;){var c=this.retrievedIds.shift();c&&b.push(c)}M.log("CookieMatcher","finishing.");var d=z.cookie_matching_url+"?";this.etid&&(d=d+"etid="+this.etid+"&"),d=d+"utidl="+b.join(","),e(d,function(a){a&&(M.info("failed to load get_id"),q("$get_id_failed"))}),this.destroy()}},_timeout:function(){this.finishIfPossible(!0)},updateCookieMatchingOut:function(a){if(this.ran){var b=z.update_cookie_matching_out_url+"?";b=b+"vid="+a+"&ops=bsw",(z.override_transport||d)(b,function(a){a&&M.error("error while loading cmout !",a)})}},destroy:function(){a.clearTimeout(this.watchDog)}},h.prototype={_parseSearch:function(a){for(var b,c,d,e=a.substring(1).split("&"),f={},g=0;g<e.length;g++)b=e[g].split("="),c=b[0],d=b[1],f[c]=decodeURIComponent(d).replace(/\+/g," ");return f},_setReady:function(){this.ready=!0},isReady:function(){return this.ready},readPage:function(){this.properties.$referrer=b.referrer,this.properties.$url=""+b.location;for(var c="utm_source utm_medium utm_term utm_content utm_campaign".split(" "),d=this._parseSearch(a.location.search),e=0;e<c.length;e++){var g=c[e];d[g]&&(this.properties["$"+g]=d[g])}if(z.local_cookie_name){var h=f(z.local_cookie_name);h&&(this.properties.raw_cookie=h)}var i=f("mics_uaid");i&&(this.properties.$uaid=i);var j=f("mics_vid");j&&(this.properties.$vid=j);var k=parseInt(f("mics_lts"),10);isNaN(k)||(this.properties.$lts=k)},getVid:function(){return this.properties.$vid},getLts:function(){return this.properties.$lts},getCookie:function(){return this.properties.$uaid},updateUAID:function(a,c,d){var e=new Date;e.setTime(e.getTime()+24*z.cookie_max_age_in_days*60*60*1e3),a&&(this.properties.$uaid=a,b.cookie="mics_uaid="+encodeURIComponent(a)+";expires="+e.toGMTString()+";path=/"),c&&(this.properties.$vid=c,b.cookie="mics_vid="+encodeURIComponent(c)+";expires="+e.toGMTString()+";path=/"),d&&(this.properties.$lts=d,b.cookie="mics_lts="+encodeURIComponent(d)+";expires="+e.toGMTString()+";path=/"),this._setReady()}},N._callQueue=[],N._reset=function(b){y&&!b||(y=!0,M.info("mics.reset"),A=null,z=c({},O),N._callQueue=[],N._token=null,C=null,D=!1,H=0,G={$sv:a.mics._snippetVersion},I=[],p(),B&&B.destroy(),B=null,N._startTime||(N._startTime=J))},N.onStart=function(a){a&&a.apply()},N.init=function(a){if("string"!=typeof a)throw new Error("mics.init : the token must be a string");if(0===a.length)throw new Error("mics.init : the token must be a non-empty string");return M.info("mics.init with token",a),N._token?void(N._token===a?M.warn("mics.init(",a,") was already called, ignoring"):M.error("ignoring mics.init(",a,"), this call was already done with a different token:",N._token)):(N._token=a,A=new h(a),B=new g(["goo","apx"],z.gather_id_timeout_ms),N.addProperty("$tv",x),A.readPage(),j(),k(A.getCookie(),A.getVid(),A.getLts()),void r(z.global_timeout_ms))},N.onFinish=function(a,b){C=a,r(b)},N.pushDefault=function(){N.push("$page_view")},N.push=function(a,b){if(!A)throw new Error("mics is not initialized, call mics.init(YOUR_TOKEN) first !");b=b||{},b.$ev=a,this._callQueue.push(b),m()},N.addProperty=function(a,b){var c={};c[a]=b,N.addProperties(c)},N.addProperties=function(a){G=c(G,a)},N.config=function(a){return a=a||{},z=c(z,a),a.cookie_matching_url?M.info("overriding cookie_matching_url with ",a.cookie_matching_url):a.domain_name&&(z.cookie_matching_url=z.protocol+z.domain_name+z.get_id_path,M.info("using custom domain, cookie_matching_url will be ",z.cookie_matching_url)),M.info("mics.config, new configuration is",z),z},N._setConfig=function(a){M.info("mics._setConfig",a),N.addProperties({$etid:a.etid}),B.setEtid(a.etid),m()},N._setOperatorId=function(a,b){B.setOperatorId(a,b)},N._setUAID=function(a,b,c){a&&(M.log("_setUAID(",a,b,c,")"),A.updateUAID(a,b,c),B.updateCookieMatchingOut(b,c)),m()};var P=function(){var a,b="init call config push pushDefault addProperties addProperty onFinish onStart".split(" "),c=[],d={};for(a=0;a<b.length;a++)d[b[a]]=!0;for(a=0;a<c.length;a++)d[c[a]]=!0;return d}();N.call=function(a){var b=Array.prototype.slice.apply(arguments).splice(1);u(N,a,b)},N._reset(!1);for(var Q=N._queue||[];Q.length;){var R=Q.shift();u(N,R.method,R.args)}a.addEventListener&&a.addEventListener("beforeunload",t,!1)}}(window,document);